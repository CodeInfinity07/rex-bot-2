const puppeteer = require('puppeteer');
const { execSync } = require('child_process');
const http = require('http');

const STREAM_URL = 'https://music-club.botpanels.live/stream';
const API_PORT = 1001;

function startShutdownServer() {
    const server = http.createServer((req, res) => {
        if (req.url === '/reset' || req.url === '/shutdown') {
            res.writeHead(200, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ success: true, message: 'Shutting down...' }));
            console.log('ðŸ›‘ Shutdown requested via API');
            setTimeout(() => process.exit(0), 100);
        } else {
            res.writeHead(200, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ status: 'running', endpoints: ['/reset', '/shutdown'] }));
        }
    });
    
    server.listen(API_PORT, '0.0.0.0', () => {
        console.log(`ðŸŒ Shutdown API running on http://localhost:${API_PORT}/reset`);
    });
    
    return server;
}

function findChromium() {
    try {
        const which = execSync('which chromium 2>/dev/null', { timeout: 3000 }).toString().trim();
        if (which) return which;
    } catch {}
    
    try {
        const which = execSync('which chromium-browser google-chrome 2>/dev/null', { timeout: 3000 }).toString().trim().split('\n')[0];
        if (which) return which;
    } catch {}
    
    const paths = [
        process.env.PUPPETEER_EXECUTABLE_PATH,
        '/usr/bin/chromium',
        '/usr/bin/chromium-browser',
        '/usr/bin/google-chrome',
        '/usr/bin/google-chrome-stable',
        '/snap/bin/chromium',
    ];
    
    for (const p of paths) {
        if (p) {
            try {
                require('fs').accessSync(p, require('fs').constants.X_OK);
                return p;
            } catch {}
        }
    }
    
    return null;
}

async function connectToStream() {
    console.log('ðŸš€ Starting headless browser...');
    
    const executablePath = findChromium();
    console.log(`ðŸ“¦ Using browser: ${executablePath || 'puppeteer default'}`);
    
    const launchOptions = {
        headless: true,
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-gpu',
            '--no-first-run',
            '--no-zygote',
            '--disable-extensions',
            '--disable-background-networking',
            '--disable-default-apps',
            '--disable-sync',
            '--disable-translate',
            '--mute-audio',
            '--hide-scrollbars',
            '--autoplay-policy=no-user-gesture-required'
        ]
    };
    
    if (executablePath) {
        launchOptions.executablePath = executablePath;
    }
    
    const browser = await puppeteer.launch(launchOptions);

    try {
        const page = await browser.newPage();
        
        console.log(`ðŸ“¡ Loading ${STREAM_URL}...`);
        await page.goto(STREAM_URL, { waitUntil: 'networkidle2', timeout: 30000 });
        
        console.log('âœ… Page loaded, looking for Connect button...');
        
        await page.waitForSelector('button', { timeout: 10000 });
        
        const clicked = await page.evaluate(() => {
            const buttons = Array.from(document.querySelectorAll('button'));
            const connectBtn = buttons.find(btn => btn.textContent.toLowerCase().includes('connect'));
            if (connectBtn) {
                connectBtn.click();
                return true;
            }
            return false;
        });
        
        if (clicked) {
            console.log('âœ… Connect button clicked!');
            
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            const status = await page.evaluate(() => {
                const text = document.body.innerText;
                if (text.includes('Connected')) return 'Connected';
                if (text.includes('Disconnected')) return 'Disconnected';
                return 'Unknown';
            });
            console.log(`ðŸ“Š Status: ${status}`);
            
            console.log('ðŸ”„ Keeping connection alive (Ctrl+C to stop)...');
            
            while (true) {
                await new Promise(resolve => setTimeout(resolve, 30000));
                console.log('ðŸ’“ Still connected...');
            }
        } else {
            console.log('âŒ Connect button not found');
            await browser.close();
            process.exit(1);
        }
        
    } catch (error) {
        console.error('âŒ Error:', error.message);
        await browser.close();
        process.exit(1);
    }
}

process.on('SIGINT', () => {
    console.log('\nðŸ‘‹ Disconnecting...');
    process.exit(0);
});

startShutdownServer();
connectToStream();